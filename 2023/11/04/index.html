<!DOCTYPE html>
<html lang="ja"><head>
  <title>
     ラジコン操縦アプリ「Happy RC Driver」のIOS対応化に向けて -  Happy RC Blog !
  </title>
  <meta name="theme-color" content="#a3001b" />
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta name="description" content="ラジコンが楽しくなるような工作やレポートを掲載したいと思います！ラジコン以外にもやってみて苦労したことや、面白かったことについても記録していく予定です！" />
  <meta name="author" content="Tomoki Ikegami" />

  <link rel="stylesheet" href="/Happy_RC.github.io/css/main.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500&family=Ubuntu+Mono&display=swap" rel="stylesheet">
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css"
  />
</head>
<body>
    
    <header class="regular-page-header shadow round-corner">
  <div
    style="
      display: flex;
      justify-content: space-between;
      width: 98%;
      margin-bottom: 0.5em;
    "
  >
    <a class="primary-icon" href="/Happy_RC.github.io/" aria-label="home page">
      <i class="bi bi-house-fill"></i>
    </a>
    
  </div>
  <div class="page-title-and-info" style="text-align: center">
    <h1 class="page-title" >
      ラジコン操縦アプリ「Happy RC Driver」のIOS対応化に向けて
    </h1>
    
    <p class="document-date">
      2023-11-04 &middot; Tomoki Ikegami
    </p>
    
    <p class="document-description">"Android＆IOS両対応の自作ラジコン操縦アプリがリリース!?"</p>
     
  </div>
</header>

    
    <main class="card shadow round-corner">
<h1 id="-目次-----omit-in-toc---">～ 目次 ～ <!-- omit in toc --></h1>
<ul>
<li><a href="#1-happy-rc-driver-%E3%83%BC-%E9%81%82%E3%81%AB-androidios-%E4%B8%A1%E5%AF%BE%E5%BF%9C%E5%8C%96">1. Happy RC Driver ー 遂に Android＆IOS 両対応化？</a></li>
<li><a href="#2-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83">2. 開発環境</a>
<ul>
<li><a href="#21-%E8%89%B2%E3%80%85%E3%81%AA%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E8%A9%A6%E3%81%99">2.1. 色々な開発環境を試す&hellip;</a></li>
<li><a href="#22-thunkable%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">2.2. Thunkableについて</a></li>
</ul>
</li>
<li><a href="#3-%E4%BD%9C%E3%81%A3%E3%81%9F%E3%82%B9%E3%83%9E%E3%83%9B%E3%82%A2%E3%83%97%E3%83%AA">3. 作ったスマホアプリ</a></li>
<li><a href="#4-esp32%E5%81%B4%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89">4. ESP32側のソースコード</a></li>
<li><a href="#5-%E3%81%BE%E3%81%A8%E3%82%81">5. まとめ</a></li>
<li><a href="#6-%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB">6. サンプルファイル</a></li>
<li><a href="#7-%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99">7. 参考資料</a></li>
</ul>
<hr>
<h1 id="1-happy-rc-driver-ー-遂に-androidios-両対応化">1. Happy RC Driver ー 遂に Android＆IOS 両対応化？</h1>
<p>　1年半ほど前から、自作のラジコン操縦アプリ「<a href="https://github.com/TomokiIkegami/Happy_RC_Driver">Happy RC Driver</a>」の開発を行っていましたが、Android版 のみの対応でした。</p>
<p>　2ヵ月ほどの試行錯誤の末、やっとAndroid＆IOS両対応の操縦アプリができました！ 現状では動作テストをAndroidのみでしか行っていないので、今度はIOS端末でもテストしようと考えています。</p>
<p>　AndroidとIOS両対応のクロスプラットフォームアプリということで、アプリ名を「<strong>Happy RC Driver CROSS</strong>」にしました！</p>
<p>　下の画像は新アプリのアイコンです～☟</p>
  <div align="center">
  <figure><img src="app_icon_cross.jpg"
         alt="アプリのアイコン"/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　アプリのアイコン
  </div>
<h1 id="2-開発環境">2. 開発環境</h1>
<h2 id="21-色々な開発環境を試す">2.1. 色々な開発環境を試す&hellip;</h2>
<p>　AndroidとIOSの両対応アプリを開発する方法は、React Native、Flutter、Xamarin など色々あることが調べてみて分かりました。友人が Flutter をやっていたので、まずは Android Studio に「Flutter」の開発環境を整えて色々やってみました。</p>
<p>　今の私には、プロジェクトの構成（たくさんあるファイルの名前や保存先）や使用するウィジェット（画面のデザイン）を理解するので精一杯で、結局諦めてしまいました。もう少し簡単な方法で「Flutter Flow」というノーコードツール（テキストベースのプログラムを書かなくてよい）がありました。　</p>
<p>　このBluetoothのチュートリアル<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>を試したのですが、Custom Actionのコードがかなり長いのと、エラーの修正に苦戦してこちらも諦めてしまいました。あと、完成したアプリをダウンロードするにはお金がかかるみたいです。私のような初心者には厳しい部分が多かったですが、このチュートリアルは説明がとても分かりやすかったです (;&lsquo;∀&rsquo;)ｲｲﾈ!</p>
<p>　最終的には「<strong>Thunkable</strong>」というWeb上で使えるアプリ開発環境を使って、今回のアプリを開発しました！</p>
  <div align="center">
  <figure><img src="flutterflow.png"
         alt="flutterflowの編集画面"/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　flutterflowの編集画面
  </div>
<h2 id="22-thunkableについて">2.2. Thunkableについて</h2>
<p>　「<a href="https://thunkable.com/">Thunkable</a>」（サンカブル？）は、プログラミング言語を使わずにドラッグ＆ドロップでアプリ開発ができます。PC上に開発環境を用意する必要もなく、ログインすればブラウザ上でアプリの開発やテストができるので手軽です。</p>
<p>　使った感じは「MIT App Inventor」にとても似ていますが、こちらはIOS対応なのが嬉しい点です。Thunkableの無料版は、プロジェクト数が10個に制限されている、作ったアプリは公開になる、アプリダウンロードは月2回 などの欠点がありますが、ガツガツ使わないので大丈夫そうです。（ガツガツやるときはMIT App Inventor使います）</p>
  <div align="center">
  <figure><img src="thunkable.png"
         alt="Thunkableのホームページ"/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　Thunkableのホームページ
  </div>
<h1 id="3-作ったスマホアプリ">3. 作ったスマホアプリ</h1>
<p>　timwooさんの記事を参考<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>にして、スマホアプリとマイコン（ESP32）側のプログラム開発を行いました（ありがとうございます）。下の画像（4枚）が試作したアプリの外観と中身になります。このアプリは、2つの画面で構成されています。</p>
<ul>
<li>
<p>control_screen：ラジコンを操縦するためのメイン画面。</p>
</li>
<li>
<p>device_page：接続可能なBluetoothデバイスの一覧を表示する画面。</p>
<div align="center">
<figure><img src="UI1a-control_screen.png"
         alt="アプリ外観（control_screen, デザイン編集タブ）"/>
</figure>

</div>
<div style="text-align: center;">
☝　アプリ外観（control_screen, デザイン編集タブ）
</div>
<div align="center">
<figure><img src="UI1a-device_page.png"
         alt="アプリ外観（device_page, デザイン編集タブ）"/>
</figure>

</div>
<div style="text-align: center;">
☝　アプリ外観（device_page, デザイン編集タブ）
</div>
<div align="center">
<figure><img src="blocks1a-control_screen.png"
         alt="アプリの中身（control_screen, ブロック編集タブ）"/>
</figure>

</div>
<div style="text-align: center;">
☝　アプリの中身（control_screen, ブロック編集タブ）
</div>
<div align="center">
<figure><img src="blocks1a-device_page.png"
         alt="アプリの中身（device_page, ブロック編集タブ）"/>
</figure>

</div>
<div style="text-align: center;">
☝　アプリの中身（device_page, ブロック編集タブ）
</div>
</li>
</ul>
<h1 id="4-esp32側のソースコード">4. ESP32側のソースコード</h1>
<p>　Arduino IDEを使って、ESP32にこのプログラム書き込みます。</p>
<p>　このプログラムでは、スマホから受信した信号に応じて、ラジコンのESCとサーボモータ制御します。<a href="https://tomokiikegami.github.io/Happy_RC.github.io/2022/10/09/">Happy RC Driver 5a</a>と、<a href="https://tomokiikegami.github.io/Happy_RC.github.io/2022/10/09/">6b</a>をベースに作成しました。</p>
<p>　スマホ・マイコン間のデータのやりとりは Bluetooth Low Energy（BLE） で行います。Bluetoothの専門用語を使うと、スマホ側は<strong>セントラル</strong>、マイコン側は<strong>ペリフェラル</strong>と呼ばれます。</p>
<p>　さらに細かい話をすると、ServiceとCharacteristicというデータ構造にUUID(Universally Unique Identifier)というIDで名前付けして、セントラル・ペリフェラル間でデータをやり取りします。Bluetoothの専門用語や動作原理は、色々な方が分かりやすく説明してくれている<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup><SUP>,</SUP><sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>ので、説明はそちらを参考にされると良いと思います。</p>
<p>　プログラムの詳細な説明は、コメント文に書いたのでご覧ください。<br><br></p>
<blockquote>
<p>　このプログラムで使用されているUUIDは Nordic UART Service (NUS)<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> というものみたいで、シリアル通信（厳密にはUART<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>という方式の）をBluetoothで無線化するときとかに使うみたいです。Nordic社のBLEモジュールに使われるものみたいですが、他社のものでも（例えばmicro:bitとか）にも使われているみたいでした。ESP32になぜ使えるのかは、私の調査した範囲では分かりませんでした。ちなみにこのプログラムでこれ以外のUUIDを使うと上手く通信できませんでした。</p>
</blockquote>
<p><br>  <div style="text-align: center;">
⇩⇩⇩ ソースコード ⇩⇩⇩</p>
  </div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/* Happy_RC_Receiver_CROSS(version 1a) *****************************
</span><span style="color:#75715e">  Get a Transmitter App:https://x.thunkable.com/projectPage/6534812c1faebb9600aa81d3
</span><span style="color:#75715e">  About this Project:https://github.com/TomokiIkegami/Happy_RC_Driver
</span><span style="color:#75715e">
</span><span style="color:#75715e">  ◆ 動作
</span><span style="color:#75715e">  1.スマホアプリ(Happy_RC_Receiver_CROSS)から命令（&#39;A&#39;～&#39;I&#39;）を取得
</span><span style="color:#75715e">  2.取得した命令に基づいて、RCを前後左右に操作
</span><span style="color:#75715e">  ◆ 機能
</span><span style="color:#75715e">  ・「Happy RC Driver」のAndroid＆IOS両対応版
</span><span style="color:#75715e">  ・アプリを開いていないときは、車体を停止させる安全機能を装備（Dragブレーキ付きESCを使用すること）
</span><span style="color:#75715e">  ・アプリ再起動時には、走行停止ボタン（画面中央のPボタン）を押さないと走行しない（アプリ再起動時に急に走行する危険を防ぐため）
</span><span style="color:#75715e">  ・カクカクではなく滑らかな走行が可能に
</span><span style="color:#75715e">  ・速度の切り替えが可能に（2種類の速度）
</span><span style="color:#75715e">  ◆ 補足
</span><span style="color:#75715e">  ・プログラム中で★マークがついている部分は、自分の装置に合わせて調整
</span><span style="color:#75715e">*************************************************************/</span>

<span style="color:#75715e">/* ServiceとCharacteristicのUUID定義 */</span>
<span style="color:#960050;background-color:#1e0010">#</span>define SERVICE_UUID <span style="color:#e6db74">&#34;6E400001-B5A3-F393-E0A9-E50E24DCCA9E&#34;</span>  <span style="color:#75715e">// UART service UUID
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>define CHARACTERISTIC_UUID_RX <span style="color:#e6db74">&#34;6E400002-B5A3-F393-E0A9-E50E24DCCA9E&#34;</span> <span style="color:#75715e">// UART characteristic UUID
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>define CHARACTERISTIC_UUID_TX <span style="color:#e6db74">&#34;6E400003-B5A3-F393-E0A9-E50E24DCCA9E&#34;</span>

<span style="color:#75715e">/*ハードウェアの接続ピンの設定*/</span>
<span style="color:#960050;background-color:#1e0010">#</span>define SERVO_PWM_PIN 4    <span style="color:#75715e">//サーボモータのPWMピン（信号入力ピン）をESP32の4番ピンに接続 ★回路と対応した番号にする
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>define ESC_PWM_PIN 16     <span style="color:#75715e">//ESCのPWMピン（信号入力ピン）をESP32の16番ピンに接続 ★回路と対応した番号にする
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*ライブラリ*/</span>
<span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#f92672">&lt;</span>ESP32Servo<span style="color:#f92672">.</span><span style="color:#a6e22e">h</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">//ESC・サーボモータの制御に使用
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#f92672">&lt;</span>BLEDevice<span style="color:#f92672">.</span><span style="color:#a6e22e">h</span><span style="color:#f92672">&gt;</span>  <span style="color:#75715e">//Bluetooth通信用
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#f92672">&lt;</span>BLEServer<span style="color:#f92672">.</span><span style="color:#a6e22e">h</span><span style="color:#f92672">&gt;</span>  <span style="color:#75715e">//Bluetooth通信用    
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#f92672">&lt;</span>BLEUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">h</span><span style="color:#f92672">&gt;</span>   <span style="color:#75715e">//Bluetooth通信用
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#f92672">&lt;</span>BLE2902<span style="color:#f92672">.</span><span style="color:#a6e22e">h</span><span style="color:#f92672">&gt;</span>    <span style="color:#75715e">//Bluetooth通信用
</span><span style="color:#75715e"></span>
BLECharacteristic <span style="color:#f92672">*</span>pCharacteristic<span style="color:#f92672">;</span> <span style="color:#75715e">//Characteristicを定義
</span><span style="color:#75715e"></span>bool deviceConnected <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span> <span style="color:#75715e">//接続状態を保存する変数
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*ESC,サーボのオブジェクト作成*/</span>
Servo myservo<span style="color:#f92672">;</span>  <span style="color:#75715e">// サーボモータを制御するためのServoオブジェクト作成
</span><span style="color:#75715e"></span>Servo myesc<span style="color:#f92672">;</span>    <span style="color:#75715e">// ESCを制御するためのServoオブジェクト作成
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> pulsew_min <span style="color:#f92672">=</span> 500<span style="color:#f92672">;</span>   <span style="color:#75715e">//minimum pulse width of servo motor（サーボモータの最小パルス幅）
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> pulsew_max <span style="color:#f92672">=</span> 2400<span style="color:#f92672">;</span>  <span style="color:#75715e">//maximum pulse width of servo motor（サーボモータの最大パルス幅）
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*ステアリングの設定*/</span>
unsigned <span style="color:#66d9ef">long</span> mov_speed_ST <span style="color:#f92672">=</span> 40<span style="color:#f92672">;</span>        <span style="color:#75715e">//ステア移動速度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> center_pos <span style="color:#f92672">=</span> 95<span style="color:#f92672">;</span>                    <span style="color:#75715e">//ステア中心位置 [サーボモータの中心位置 (90°)]　★まっすぐ走るように調整。90より大きい値にするとステア（ハンドル）が右寄りに、90より小さい値にするとステア（ハンドル）が左寄りになる
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> left_DR <span style="color:#f92672">=</span> 20<span style="color:#f92672">;</span>                       <span style="color:#75715e">//左の切れ角 ★:好みに合わせて調整。ただし大きくしすぎないように注意。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> right_DR <span style="color:#f92672">=</span> 25<span style="color:#f92672">;</span>                      <span style="color:#75715e">//右の切れ角 ★:好みに合わせて調整。ただし大きくしすぎないように注意。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> left_max <span style="color:#f92672">=</span> center_pos <span style="color:#f92672">-</span> left_DR<span style="color:#f92672">;</span>    <span style="color:#75715e">//左ステアの最大位置 [中心位置より反時計回りに20°（left_DR）回転した位置] ★逆に動くときはleft_DRの手前の符号をプラス（+）に
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> right_max <span style="color:#f92672">=</span> center_pos <span style="color:#f92672">+</span> right_DR<span style="color:#f92672">;</span>  <span style="color:#75715e">//右ステアの最大位置 [中心位置より時計回りに25°（right_DR）回転した位置] ★逆に動くときはright_DRの手前の符号をマイナス（-）に
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*スロットルの設定*/</span>
unsigned <span style="color:#66d9ef">long</span> mov_speed_TH <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>                <span style="color:#75715e">//スロットル移動速度
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> mov_speed_brk <span style="color:#f92672">=</span> 40<span style="color:#f92672">;</span>              <span style="color:#75715e">//ブレーキ速度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> neutral_pos <span style="color:#f92672">=</span> 93<span style="color:#f92672">;</span>                          <span style="color:#75715e">//中立位置 [スロットルの中立位置 (90) ★ESCの設定によってずれがあるので、前後に走行しないよう値を調整する。※ ESC側を90で中立になるよう設定（上級者向け。ESCの説明書通りプロポでニュートラル設定を済ませてから、このプログラムの値を調整するのがオススメ）してもよい。]
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> forward_DR <span style="color:#f92672">=</span> 20<span style="color:#f92672">;</span>                           <span style="color:#75715e">//前進の速さ ★好みの速度に調整
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> backward_DR <span style="color:#f92672">=</span> 20<span style="color:#f92672">;</span>                          <span style="color:#75715e">//バックの速さ ★好みの速度に調整
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> forward_max <span style="color:#f92672">=</span> neutral_pos <span style="color:#f92672">+</span> forward_DR<span style="color:#f92672">;</span>    <span style="color:#75715e">//前進の最大位置 ★逆に動くときはforward_DRの手前の符号をマイナス（-）に
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> backward_max <span style="color:#f92672">=</span> neutral_pos <span style="color:#f92672">-</span> backward_DR<span style="color:#f92672">;</span>  <span style="color:#75715e">//バックの最大位置 ★逆に動くときはbackward_DRの手前の符号をプラス（+）に
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> turbo_speed <span style="color:#f92672">=</span> 120<span style="color:#f92672">;</span>                         <span style="color:#75715e">//全開走行時の速度（180が最大。速すぎると思ったら170や160など値を小さくしてみる）
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*値設定の注意点*/</span>
<span style="color:#75715e">//速度(mov_speed_ST,mov_speed_TH)は 0-50 の範囲で与える。（0：最低速度、50:最大速度）
</span><span style="color:#75715e">//スロットル、サーボモータの値(pos)の範囲は、 0≦ pos ≦180 で与える。
</span><span style="color:#75715e">//myservo.write 関数には回転角を絶対的な位置で与える。例) 90°から 45°反時計回りに動いてほしいときは、-45ではなく、45を関数に入力する。
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*ステアとスロットルの位置を記憶する変数*/</span>
<span style="color:#66d9ef">int</span> CH1 <span style="color:#f92672">=</span> center_pos<span style="color:#f92672">;</span>   <span style="color:#75715e">//CH1:ステア
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> CH2 <span style="color:#f92672">=</span> neutral_pos<span style="color:#f92672">;</span>  <span style="color:#75715e">//CH2:スロットル
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*プログラムの流れを制御する変数*/</span>
<span style="color:#66d9ef">char</span> input <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C&#39;</span><span style="color:#f92672">;</span>             <span style="color:#75715e">//入力信号
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> curr<span style="color:#f92672">;</span>           <span style="color:#75715e">/*現在時刻を保存*/</span>
unsigned <span style="color:#66d9ef">long</span> prev_ST <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>    <span style="color:#75715e">/*前時刻を保存*/</span>
unsigned <span style="color:#66d9ef">long</span> prev_TH <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>    <span style="color:#75715e">/*前時刻を保存*/</span>

<span style="color:#75715e">/*PWM制御でサーボモータの角度を制御する関数*/</span>
<span style="color:#75715e">/*ステアを操作する関数*/</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">change_ST_pos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> goal_pos<span style="color:#f92672">,</span> unsigned <span style="color:#66d9ef">long</span> mov_speed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  unsigned <span style="color:#66d9ef">long</span> delay_time <span style="color:#f92672">=</span> 50 <span style="color:#f92672">-</span> mov_speed<span style="color:#f92672">;</span>  <span style="color:#75715e">//処理を遅くする時間（この値が大きいとゆっくりな操作に）
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>curr <span style="color:#f92672">-</span> prev_ST<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> delay_time<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/*ステアを切る処理*/</span>
    <span style="color:#75715e">//右折
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>goal_pos <span style="color:#f92672">-</span> CH1 <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      CH1<span style="color:#f92672">++;</span>
      myservo<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>CH1<span style="color:#f92672">);</span>
      <span style="color:#75715e">//左折
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>goal_pos <span style="color:#f92672">-</span> CH1 <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      CH1<span style="color:#f92672">--;</span>
      myservo<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>CH1<span style="color:#f92672">);</span>

      <span style="color:#75715e">//その他→ステアはそのまま
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      myservo<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>CH1<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    prev_ST <span style="color:#f92672">=</span> curr<span style="color:#f92672">;</span>  <span style="color:#75715e">//前回に処理を実行した時刻を現在時刻に更新
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">/*スロットルを操作する関数*/</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">change_TH_pos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> goal_pos<span style="color:#f92672">,</span> unsigned <span style="color:#66d9ef">long</span> mov_speed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  unsigned <span style="color:#66d9ef">long</span> delay_time <span style="color:#f92672">=</span> 50 <span style="color:#f92672">-</span> mov_speed<span style="color:#f92672">;</span>  <span style="color:#75715e">//処理を遅くする時間（この値が大きいとゆっくりな操作に）
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>curr <span style="color:#f92672">-</span> prev_TH<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> delay_time<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/*スロットルを操作する処理*/</span>
    <span style="color:#75715e">//前進
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>goal_pos <span style="color:#f92672">-</span> CH2 <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      CH2<span style="color:#f92672">++;</span>
      myesc<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>CH2<span style="color:#f92672">);</span>
      <span style="color:#75715e">//後退
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>goal_pos <span style="color:#f92672">-</span> CH2 <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      CH2<span style="color:#f92672">--;</span>
      myesc<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>CH2<span style="color:#f92672">);</span>

      <span style="color:#75715e">//その他→スロットルはそのまま
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      myesc<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>CH2<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    prev_TH <span style="color:#f92672">=</span> curr<span style="color:#f92672">;</span>  <span style="color:#75715e">//前回に処理を実行した時刻を現在時刻に更新
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">/*接続状態を更新するクラス*/</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyServerCallbacks</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> BLEServerCallbacks <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onConnect</span><span style="color:#f92672">(</span>BLEServer <span style="color:#f92672">*</span>pServer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    deviceConnected <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">};</span>

  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onDisconnect</span><span style="color:#f92672">(</span>BLEServer <span style="color:#f92672">*</span>pServer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    deviceConnected <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">};</span>

<span style="color:#75715e">/*スマホから受信した値を取得するクラス*/</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyCallbacks</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> BLECharacteristicCallbacks <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onWrite</span><span style="color:#f92672">(</span>BLECharacteristic <span style="color:#f92672">*</span>pCharacteristic<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    std<span style="color:#f92672">::</span>string rxValue <span style="color:#f92672">=</span> pCharacteristic<span style="color:#f92672">-&gt;</span>getValue<span style="color:#f92672">();</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rxValue<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> rxValue<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        input <span style="color:#f92672">=</span> rxValue<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">};</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">begin</span><span style="color:#f92672">(</span>115200<span style="color:#f92672">);</span> <span style="color:#75715e">//シリアルモニタで確認用。伝送速度は115200[bps]に設定。
</span><span style="color:#75715e"></span>  myservo<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>SERVO_PWM_PIN<span style="color:#f92672">,</span> pulsew_min<span style="color:#f92672">,</span> pulsew_max<span style="color:#f92672">);</span>  <span style="color:#75715e">//サーボモータのPWM端子とArduinoの4番ピンを接続 ★回路と対応した番号にする
</span><span style="color:#75715e"></span>  myesc<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>ESC_PWM_PIN<span style="color:#f92672">,</span> pulsew_min<span style="color:#f92672">,</span> pulsew_max<span style="color:#f92672">);</span>      <span style="color:#75715e">//ESCのPWM端子とArduinoの16番ピンを接続 ★回路と対応した番号にする
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// Create the BLE Device（BLEデバイスの作成）
</span><span style="color:#75715e"></span>  BLEDevice<span style="color:#f92672">::</span>init<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Happy_RC_Receiver_CROSS&#34;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">// Give it a name
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// Create the BLE Server（BLEサーバの作成）
</span><span style="color:#75715e"></span>  BLEServer <span style="color:#f92672">*</span>pServer <span style="color:#f92672">=</span> BLEDevice<span style="color:#f92672">::</span>createServer<span style="color:#f92672">();</span>
  pServer<span style="color:#f92672">-&gt;</span>setCallbacks<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> MyServerCallbacks<span style="color:#f92672">());</span>

  <span style="color:#75715e">// Create the BLE Service（BLE Serviceの作成）
</span><span style="color:#75715e"></span>  BLEService <span style="color:#f92672">*</span>pService <span style="color:#f92672">=</span> pServer<span style="color:#f92672">-&gt;</span>createService<span style="color:#f92672">(</span>SERVICE_UUID<span style="color:#f92672">);</span>

  <span style="color:#75715e">// Create a BLE Characteristic（BLE Characteristicの作成）
</span><span style="color:#75715e"></span>  pCharacteristic <span style="color:#f92672">=</span> pService<span style="color:#f92672">-&gt;</span>createCharacteristic<span style="color:#f92672">(</span>
    CHARACTERISTIC_UUID_TX<span style="color:#f92672">,</span>
    BLECharacteristic<span style="color:#f92672">::</span>PROPERTY_NOTIFY<span style="color:#f92672">);</span>

  pCharacteristic<span style="color:#f92672">-&gt;</span>addDescriptor<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BLE2902<span style="color:#f92672">());</span>  <span style="color:#75715e">//Desctipterの追加。この行はなくても動くらしいです
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">/* 今回の場合は「セントラル=スマホ」、「ペリフェラル=ESP32マイコン」 */</span>
  <span style="color:#75715e">/* CharacteristicにUUIDと属性を追加（セントラルからペリフェラルに値を書き込むので、ペリフェラル側の 受信用characteristicのUUID に WRITE属性 を追加）*/</span>
  BLECharacteristic <span style="color:#f92672">*</span>pCharacteristic <span style="color:#f92672">=</span> pService<span style="color:#f92672">-&gt;</span>createCharacteristic<span style="color:#f92672">(</span>
    CHARACTERISTIC_UUID_RX<span style="color:#f92672">,</span>
    BLECharacteristic<span style="color:#f92672">::</span>PROPERTY_WRITE<span style="color:#f92672">);</span>

  pCharacteristic<span style="color:#f92672">-&gt;</span>setCallbacks<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> MyCallbacks<span style="color:#f92672">());</span>

  <span style="color:#75715e">// Start the service（Serviceの開始）
</span><span style="color:#75715e"></span>  pService<span style="color:#f92672">-&gt;</span>start<span style="color:#f92672">();</span>

  <span style="color:#75715e">// Start advertising（Advertisingの開始。RC Receiver の存在をスマホに知らせる）
</span><span style="color:#75715e"></span>  pServer<span style="color:#f92672">-&gt;</span>getAdvertising<span style="color:#f92672">()-&gt;</span>start<span style="color:#f92672">();</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Waiting a client connection to notify...&#34;</span><span style="color:#f92672">);</span>

  <span style="color:#75715e">/*勝手には走りださないように設定*/</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Initializing ST and TH position....&#34;</span><span style="color:#f92672">);</span>
  myservo<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>center_pos<span style="color:#f92672">);</span>  <span style="color:#75715e">// ステアを中心(Center)に
</span><span style="color:#75715e"></span>  myesc<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>neutral_pos<span style="color:#f92672">);</span>   <span style="color:#75715e">//中立(Neutral)
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">/*デバイスが接続されている間のみ処理を実行*/</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deviceConnected<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    curr <span style="color:#f92672">=</span> millis<span style="color:#f92672">();</span>  <span style="color:#75715e">//現在時刻を取得
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/*命令に基づいてラジコンを制御*/</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>center_pos<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>   <span style="color:#75715e">// ステアを中心(Center)に
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>forward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//前進(Forward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;B&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>center_pos<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>    <span style="color:#75715e">// ステアを中心(Center)に
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>backward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//後退(Backward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;C&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      forward_max <span style="color:#f92672">=</span> neutral_pos <span style="color:#f92672">+</span> forward_DR<span style="color:#f92672">;</span>     <span style="color:#75715e">//標準の速度に設定
</span><span style="color:#75715e"></span>      change_ST_pos<span style="color:#f92672">(</span>center_pos<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>    <span style="color:#75715e">// ステアを中心(Center)に
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>neutral_pos<span style="color:#f92672">,</span> mov_speed_brk<span style="color:#f92672">);</span>  <span style="color:#75715e">//中立(Neutral)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;D&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>left_max<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>      <span style="color:#75715e">// ステアを左(Left)に切る
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>neutral_pos<span style="color:#f92672">,</span> mov_speed_brk<span style="color:#f92672">);</span>  <span style="color:#75715e">//中立(Neutral)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;E&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>right_max<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>     <span style="color:#75715e">// ステアを右(Right)に切る
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>neutral_pos<span style="color:#f92672">,</span> mov_speed_brk<span style="color:#f92672">);</span>  <span style="color:#75715e">//中立(Neutral)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;F&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>left_max<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>     <span style="color:#75715e">// ステアを左(Left)に切る
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>forward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//前進(Forward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;G&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>right_max<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>    <span style="color:#75715e">// ステアを右(Right)に切る
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>forward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//前進(Forward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;H&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>left_max<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>      <span style="color:#75715e">// ステアを左(Left)に切る
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>backward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//後退(Backward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;I&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>right_max<span style="color:#f92672">,</span> mov_speed_ST<span style="color:#f92672">);</span>     <span style="color:#75715e">// ステアを右(Right)に切る
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>backward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//後退(Backward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;J&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      forward_max <span style="color:#f92672">=</span> turbo_speed<span style="color:#f92672">;</span>                 <span style="color:#75715e">//ターボの速度に設定
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>forward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//前進(Forward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;K&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      forward_max <span style="color:#f92672">=</span> neutral_pos <span style="color:#f92672">+</span> forward_DR<span style="color:#f92672">;</span>    <span style="color:#75715e">//標準の速度に設定
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>forward_max<span style="color:#f92672">,</span> mov_speed_TH<span style="color:#f92672">);</span>  <span style="color:#75715e">//前進(Forward)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      change_ST_pos<span style="color:#f92672">(</span>center_pos<span style="color:#f92672">,</span> 50<span style="color:#f92672">);</span>   <span style="color:#75715e">// ステアを中心(Center)に
</span><span style="color:#75715e"></span>      change_TH_pos<span style="color:#f92672">(</span>neutral_pos<span style="color:#f92672">,</span> 50<span style="color:#f92672">);</span>  <span style="color:#75715e">//中立(Neutral)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    change_ST_pos<span style="color:#f92672">(</span>center_pos<span style="color:#f92672">,</span> 50<span style="color:#f92672">);</span>   <span style="color:#75715e">// ステアを中心(Center)に
</span><span style="color:#75715e"></span>    change_TH_pos<span style="color:#f92672">(</span>neutral_pos<span style="color:#f92672">,</span> 50<span style="color:#f92672">);</span>  <span style="color:#75715e">//中立(Neutral)
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span></code></pre></div>
<h1 id="5-まとめ">5. まとめ</h1>
<p>　Android＆IOS両対応のアプリを作るのにかなり苦労しましたが、色々な方の記事のおかげで何とか形にすることができました。本当にありがとうございます！</p>
<p>　現在（2023/11/05時点）IOSでは、Thunkable Live上でBLE機能が使えませんが、「Donwload IOS」で自分のスマホ上にインストールすれば使えるようです。</p>
<p>　今後はIOS端末でもアプリをテストしてみたいと思います(^_^)/~</p>
<h1 id="6-サンプルファイル">6. サンプルファイル</h1>
<p>　作成したアプリのデータはこちらになります。改良して愛車に搭載するなど自由に楽しんでください！</p>
<p><strong>～ Thunkableプロジェクトへのリンク ～</strong></p>
<p>　<a href="https://thunkable.com/mobile">Thunkable Live</a>というアプリをスマホにインストールすると、作ったアプリをテストすることができます。ブラウザで下のリンクを開くとプロジェクトの概要ページが開くので、画面上にある「Copy Project」をクリックしてください。</p>
<ul>
<li><a href="https://x.thunkable.com/projectPage/6534812c1faebb9600aa81d3">「Happy_RC_Driver_1a」のThunkable Projectページ</a></li>
</ul>
<h1 id="7-参考資料">7. 参考資料</h1>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Flutter Flow「Creating an App for Interacting with IoT Devices using BLE and FlutterFlow」、(<a href="https://blog.flutterflow.io/creating-an-app-for-interacting-with-any-iot-devices-using-ble/">https://blog.flutterflow.io/creating-an-app-for-interacting-with-any-iot-devices-using-ble/</a>)&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Autodesk Instractables「ESP32 BLE + Android + Arduino IDE = AWESOME」、(<a href="https://www.instructables.com/ESP32-BLE-Android-App-Arduino-IDE-AWESOME/">https://www.instructables.com/ESP32-BLE-Android-App-Arduino-IDE-AWESOME/</a>)&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>ものものテック「開発視点の超簡単BLE入門」、(<a href="https://monomonotech.jp/kurage/webbluetooth/ble_guide.html">https://monomonotech.jp/kurage/webbluetooth/ble_guide.html</a>)&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>わわわIT用語辞典 「UUID」、(<a href="https://wa3.i-3-i.info/word13163.html">https://wa3.i-3-i.info/word13163.html</a>)&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p>NORDIC SEMICONDUCTOR「Nordic UART Service (NUS)」、(<a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/libraries/bluetooth_services/services/nus.html">https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/libraries/bluetooth_services/services/nus.html</a>)&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p>Embedded Technology Lab.「よく分かる！ シリアル通信基礎講座」、(<a href="https://emb.macnica.co.jp/articles/8191/">https://emb.macnica.co.jp/articles/8191/</a>)&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


    </main><footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      TeX: { equationNumbers: {autoNumber: "AMS"} },
      tex2jax: {
        inlineMath: [['$','$']]
      }
    });
  </script>
  
  
  
  
  <div class="prev-next">
    <a
      class="active icon"
      href="/Happy_RC.github.io/2023/09/08/"
      aria-label="Previous Article"
      ><i class="bi bi-arrow-left-circle-fill"></i
    ></a>
    <a
      class="active icon"
      href="/Happy_RC.github.io/2023/12/24/"
      aria-label="Next Article"
      ><i class="bi bi-arrow-right-circle-fill"></i
    ></a>
  </div>
  </div>
  
  <div class="footer shadow round-corner">
    
    <div class="grid-container">
      <div class="footer-recent-posts">
        <h6>Recent Posts</h6>
        <ol>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2024/01/01/">「Command &#39;cmd&#39; not found, but there are 18 similar ones.」と表示されてPythonが実行できない</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/12/24/">ラジコン用スピードメータの高速化</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/11/04/">ラジコン操縦アプリ「Happy RC Driver」のIOS対応化に向けて</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/09/08/">Bluetooth モジュールでRCサーボ・ESCを制御したい [第14回-走行用バッテリーからマイコンに給電]</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/08/11/">Bluetooth モジュールでRCサーボ・ESCを制御したい [第13回-ラジコンアプリに車速を表示]</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/06/18/">OPPO Reno8 Pro 5G 中国版とグローバル版、実はかなり違う</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/06/06/">OPPO Reno8 Pro 5G（中国版）レビュー</a></li>
          
        </ol>
        <a href="/Happy_RC.github.io/archive">...ALL POSTS</a>
        <hr class="mobile white-hr" />
      </div>
      <div>
        <h6>Sections</h6>
<div class="section-container">
  
  
  <a class="section" href="https://tomokiikegami.github.io/Happy_RC.github.io/post/" aria-label="site sections"
    >Posts</a
  >
  
  
  
  
  
  
</div>

        









<h6>
  Tags
</h6>

<div class="taxa-container">
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/arduino/">Arduino</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E7%84%A1%E7%B7%9A%E9%80%9A%E4%BF%A1/">無線通信</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E8%87%AA%E4%BD%9C%E3%82%A2%E3%83%97%E3%83%AA/">自作アプリ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/mit-app-inventor/">MIT App Inventor</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%82%B5%E3%83%BC%E3%83%9C/">サーボ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/esc/">ESC</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/freecad/">FreeCAD</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/3d%E3%83%A2%E3%83%87%E3%83%AA%E3%83%B3%E3%82%B0/">3Dモデリング</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E6%A9%9F%E6%A2%B0%E8%A8%AD%E8%A8%88/">機械設計</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/3d%E3%83%97%E3%83%AA%E3%83%B3%E3%82%BF/">3Dプリンタ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%82%AE%E3%82%A2/">ギア</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%82%B9%E3%83%9E%E3%83%9B/">スマホ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/ultimaker-cura/">Ultimaker Cura</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/word/">Word</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E6%96%87%E5%AD%97%E8%A3%85%E9%A3%BE/">文字装飾</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/arduinodroid/">ArduinoDroid</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/html%E3%82%BF%E3%82%B0/">htmlタグ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/hugo/">hugo</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/ios/">IOS</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/libreoffice-draw/">LibreOffice Draw</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/python/">Python</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/thunkable/">Thunkable</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/vs-code/">VS Code</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97/">バックアップ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%83%9C%E3%83%87%E3%82%A3%E5%A1%97%E8%A3%85/">ボディ塗装</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E5%9B%B3%E3%81%AE%E4%BD%9C%E6%88%90/">図の作成</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E8%A8%88%E6%B8%AC%E5%88%B6%E5%BE%A1/">計測制御</a>
  
</div>


<h6>
  Categories
</h6>

<div class="taxa-container">
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/categories/%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3/">ラジコン</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/categories/%E5%82%99%E5%BF%98%E9%8C%B2/">備忘録</a>
  
</div>


        <hr class="mobile white-hr" />
      </div>
    </div>
    
    <div class="footer-info-text">
      <p>
        
        <span>2024</span>
        <span>Tomoki Ikegami.</span>
        <span>I hope to enjoy your RC Life.</span>
      </p>
      <p>
        <a href="https://github.com/urjaacharya/redgood">redgood</a>
        by
        <a
          href="https://www.urjaacharya.com/"
          aria-label="link to urja acharya site"
        >urja acharya</a>
      </p>
    </div>
    <div style="text-align: right; margin-bottom: 0.25em; font-size: 1.2em">
      <a class="primary-icon to-top" href="#" aria-label="navigate to top">
        <i class="bi bi-arrow-up-circle-fill"></i>
      </a>
    </div>
  </div>
</footer>
</body>
</html>
