<!DOCTYPE html>
<html lang="ja"><head>
  <title>
     Bluetooth モジュールでRCサーボ・ESCを制御したい [第10回-スライダ操作式のラジコンアプリに] -  Happy RC Blog !
  </title>
  <meta name="theme-color" content="#a3001b" />
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta name="description" content="ラジコンが楽しくなるような工作やレポートを掲載したいと思います！ラジコン以外にもやってみて苦労したことや、面白かったことについても記録していく予定です！" />
  <meta name="author" content="Tomoki Ikegami" />

  <link rel="stylesheet" href="/Happy_RC.github.io/css/main.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500&family=Ubuntu+Mono&display=swap" rel="stylesheet">
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css"
  />
</head>
<body>
    
    <header class="regular-page-header shadow round-corner">
  <div
    style="
      display: flex;
      justify-content: space-between;
      width: 98%;
      margin-bottom: 0.5em;
    "
  >
    <a class="primary-icon" href="/Happy_RC.github.io/" aria-label="home page">
      <i class="bi bi-house-fill"></i>
    </a>
    
  </div>
  <div class="page-title-and-info" style="text-align: center">
    <h1 class="page-title" >
      Bluetooth モジュールでRCサーボ・ESCを制御したい [第10回-スライダ操作式のラジコンアプリに]
    </h1>
    
    <p class="document-date">
      2023-03-16 &middot; Tomoki Ikegami
    </p>
    
    <p class="document-description">"本格的なラジコンプロポのように滑らかにステアやスロットルを操作したい"</p>
     
  </div>
</header>

    
    <main class="card shadow round-corner">
<h1 id="-目次-----omit-in-toc---">～ 目次 ～ <!-- omit in toc --></h1>
<ul>
<li><a href="#1-%E4%BB%8A%E5%9B%9E%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8">1. 今回やりたいこと</a></li>
<li><a href="#2-%E5%8B%95%E4%BD%9C%E5%8E%9F%E7%90%86">2. 動作原理</a></li>
<li><a href="#3-%E6%94%B9%E8%89%AF%E3%81%AE%E9%81%8E%E7%A8%8B">3. 改良の過程</a>
<ul>
<li><a href="#31-%E3%82%B9%E3%83%9E%E3%83%9B%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E6%94%B9%E8%89%AF">3.1. スマホアプリの改良</a>
<ul>
<li><a href="#311-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F">3.1.1. アプリの全体像</a></li>
<li><a href="#312-%E3%82%B9%E3%83%86%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%83%88%E3%83%AA%E3%83%A0st-trim%E6%A9%9F%E8%83%BD">3.1.2. ステアリングトリム（ST. TRIM）機能</a></li>
<li><a href="#313-%E5%8B%95%E4%BD%9C%E6%96%B9%E5%90%91%E5%8F%8D%E8%BB%A2st-revth-rev%E6%A9%9F%E8%83%BD">3.1.3. 動作方向反転（ST. REV、TH. REV）機能</a></li>
</ul>
</li>
<li><a href="#32-%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%90%E5%81%B4%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E6%94%B9%E8%89%AF">3.2. レシーバ側プログラムの改良</a></li>
</ul>
</li>
<li><a href="#4-%E5%AE%9F%E9%A8%93%E5%8B%95%E7%94%BB">4. 実験動画</a></li>
<li><a href="#5-%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB">5. サンプルファイル</a></li>
<li><a href="#6-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">6. 参考文献</a></li>
</ul>
<hr>
<h1 id="1-今回やりたいこと">1. 今回やりたいこと</h1>
<p>　今まで（本連載の4～9回）は9つのボタンを押すことでラジコンを操縦していました。このボタン式のコントローラだと滑らかに操縦ができません(;^ω^)</p>
<p>　今回からスライダ式に変更して、滑らかに操縦できるようにしました！</p>
  <div align="center">
  <figure><img src="new_app_design.png"
         alt="ボタン式からスライダ式に（本格的！！） "/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　ボタン式からスライダ式に（本格的！！）
  </div>
<h1 id="2-動作原理">2. 動作原理</h1>
<p>　基本的な動作原理は<a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/01/02/">こちらの記事</a>で紹介したものと同じですが、今回はステアだけでなくスロットルの信号も追加しました。これでラジコンのハンドルとアクセルの両方が操作できるようになります。（下図）</p>
  <div align="center">
  <figure><img src="RC%e3%82%b5%e3%83%bc%e3%83%9c%e3%81%a8ESC%e3%81%aePWM%e5%88%b6%e5%be%a1.svg"
         alt="サーボモータとESCのPWM制御"/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　サーボモータとESCのPWM制御
  </div>
<p>　動作原理を下の図にまとめました。ステアの信号をCH1、スロットルの信号をCH2とします。</p>
<p>　大まかな処理手順は、</p>
<ol>
<li>スマホアプリ側からステア、スロットルの信号を1つの文字列として送信（ステア、スロットル信号はカンマ(,)で区切る）</li>
<li>マイコン側で文字列を受け取り、カンマ(,)で分割<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li>分割した文字列の左側をCH1(ステア)、右側をCH2(スロットル)の信号とする</li>
<li>CH1とCH2の値に基づいてサーボモータとESCをそれぞれ制御し、ステアとスロットルを操作</li>
</ol>
<p>　となります。ここで、手順1はスマホアプリ側、手順2~4はマイコン(ESP32)側で行っている処理になります。</p>
  <div align="center">
  <figure><img src="%e5%87%a6%e7%90%86%e3%81%ae%e6%a6%82%e8%a6%81.svg"
         alt="処理の概要"/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　処理の概要
  </div>
<h1 id="3-改良の過程">3. 改良の過程</h1>
<h2 id="31-スマホアプリの改良">3.1. スマホアプリの改良</h2>
<h3 id="311-アプリの全体像">3.1.1. アプリの全体像</h3>
<p>　こちらが改良後のアプリになります。</p>
<p>　実際の送信機（プロポ）ではスティックを使ってステアとスロットルを操縦しますが、アプリ上ではスティックの代わりにスライダで操縦します。</p>
  <div align="center">
  <figure><img src="UI7a.png"
         alt="アプリ外観（デザイン編集タブ）"/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　アプリ外観（デザイン編集タブ）
  </div>
  <div align="center">
  <figure><img src="blocks7a.png"
         alt="アプリの中身（ブロック編集タブ）"/>
</figure>

  </div>
  <div style="text-align: center;">
  ☝　アプリの中身（ブロック編集タブ）
  </div>
<p>　MIT App Inventorには元々縦向きのスライダが用意されていないので、Juanさんの作成した垂直スライダの拡張機能 SliderVertical.aix<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> を使用しました。ここでは、アプリの起動と同時に縦向きのスライダが生成（なのでデザイン編集タブでは縦向きスライダが表示されていない）するようにしています。</p>
<p>　さらに、スライダから指を離すとステアが中立位置に戻るようにしました。</p>
<p>　この処理には、WatermelonOofさんのSliderTools-AI2-Kodular-Extension<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>を使用しました。スロットルも同じようにしたかったのですが、垂直スライダ用の拡張機能との組み合わせが難しく、とりあえず諦めました（笑）</p>
<h3 id="312-ステアリングトリムst-trim機能">3.1.2. ステアリングトリム（ST. TRIM）機能</h3>
<p>　本格的なラジコン用プロポと同じようにステアリングトリム（ST. TRIM）を実装しました。「+」、「-」ボタンを押すことで車体がまっすぐ走るように調整することができます。</p>
<h3 id="313-動作方向反転st-revth-rev機能">3.1.3. 動作方向反転（ST. REV、TH. REV）機能</h3>
<p>　ステアやスロットルが動いてほしい方向と逆のときに、動作方向を修正できる機能です。スイッチの使い方が分からなかったので、YouTube動画<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>を参考に作業しました。</p>
<h2 id="32-レシーバ側プログラムの改良">3.2. レシーバ側プログラムの改良</h2>
<p>　改良版のプログラムがこちらになります。スマホアプリから受け取ったパルス幅に基づいてステア・スロットルを操作します。</p>
<p>　さらに、安全性に配慮してアプリが閉じたときは走行を停止する処理を入れています。（<a href="https://tomokiikegami.github.io/Happy_RC.github.io/2022/08/30/">ver.5b</a>で採用）</p>
  <br>
  <div style="text-align: center;">
⇩⇩⇩ ソースコード ⇩⇩⇩
  </div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/* Happy_RC_Receiver(version 7a) *****************************
</span><span style="color:#75715e">  Download a Transmitter App:https://github.com/TomokiIkegami/Happy_RC_Driver/raw/develop/Happy_RC_Driver.apk
</span><span style="color:#75715e">  About this Project:https://github.com/TomokiIkegami/Happy_RC_Driver
</span><span style="color:#75715e">
</span><span style="color:#75715e">  ◆ 動作
</span><span style="color:#75715e">  1.スマホアプリ(Happy_RC_Receiver)から命令（ステア、スロットルのパルス幅）を取得
</span><span style="color:#75715e">  2.取得した命令に基づいて、RCを前後左右に操作
</span><span style="color:#75715e">  ◆ 機能
</span><span style="color:#75715e">  ・アプリを開いていないときは、車体を停止させる安全機能を装備（Dragブレーキ付きESCを使用すること）
</span><span style="color:#75715e">  ・アプリ再起動時には、スロットルを中立に戻さないと走行しない（アプリ再起動時に急に走行する危険を防ぐため）
</span><span style="color:#75715e">  ・カクカクではなく滑らかな走行が可能
</span><span style="color:#75715e">  ◆ 補足
</span><span style="color:#75715e">  ・プログラム中で★マークがついている部分は、自分の装置に合わせて調整
</span><span style="color:#75715e">*************************************************************/</span>

<span style="color:#75715e">/*ハードウェアの接続ピンの設定*/</span>
<span style="color:#960050;background-color:#1e0010">#</span>define LED_PIN 2 <span style="color:#75715e">//走行には無関係。2番ピンにLEDのアノード(+)を接続すると割り込み処理の間隔(100ms)でLEDが点滅
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>define LED_PIN_ACTIVE 17 <span style="color:#75715e">//走行には無関係。17番ピンにLEDのアノード(+)を接続すると、アプリ起動時のみLEDが点灯
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>define SERVO_PWM_PIN 4  <span style="color:#75715e">//サーボモータのPWMピン（信号入力ピン）をESP32の4番ピンに接続 ★回路と対応した番号にする
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span>define ESC_PWM_PIN 16   <span style="color:#75715e">//ESCのPWMピン（信号入力ピン）をESP32の16番ピンに接続 ★回路と対応した番号にする
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*タイマーの定義*/</span>
hw_timer_t<span style="color:#f92672">*</span>timer <span style="color:#f92672">=</span> NULL<span style="color:#f92672">;</span>

<span style="color:#75715e">/*ライブラリ*/</span>
<span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;BluetoothSerial.h&#34;</span>  <span style="color:#75715e">//ESP32のBluetooth通信に使用
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*ステアとスロットルの設定*/</span>
<span style="color:#66d9ef">int</span> PWM_period <span style="color:#f92672">=</span> 20000<span style="color:#f92672">;</span>  <span style="color:#75715e">//PWM周期をT=20000[μs]に設定
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> center_pos <span style="color:#f92672">=</span> 1500<span style="color:#f92672">;</span>   <span style="color:#75715e">//ステア中心位置 [サーボモータ中心位置のパルス幅 (1500)]
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> neutral_pos <span style="color:#f92672">=</span> 1500<span style="color:#f92672">;</span>  <span style="color:#75715e">//中立位置 [スロットル中立位置のパルス幅 (1500)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> CH1 <span style="color:#f92672">=</span> center_pos<span style="color:#f92672">;</span>    <span style="color:#75715e">//パルス幅Tonを1500[μs]（中立）に設定。データシートにはLeft=900[μs]、Neutral=1500[μs]、Right=2100[μs]と記載されていた。(HiTEC DB777WP)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> CH2 <span style="color:#f92672">=</span> neutral_pos<span style="color:#f92672">;</span>   <span style="color:#75715e">//パルス幅Tonを1500[μs]（中立）に設定。
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*プログラムの流れを制御する変数*/</span>
<span style="color:#66d9ef">int</span> flag <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>  <span style="color:#75715e">//アプリの起動状態を管理する変数。アプリがバックグラウンドに入ったときは1に設定する。アプリがバックグラウンドから復帰し、アプリのPボタンが押されたら0に設定してラジコン操作を有効にする。
</span><span style="color:#75715e"></span>String input <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1500,1500&#34;</span><span style="color:#f92672">;</span>   <span style="color:#75715e">//入力信号
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> t1 <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>         <span style="color:#75715e">//データ受信時間
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> t2 <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>         <span style="color:#75715e">//割り込み時の時間
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> td <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>         <span style="color:#75715e">//データ受信時間と割り込み時間の差
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> t_loss_ST <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>  <span style="color:#75715e">//ステア操作で失われた時間
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> t_loss_TH <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>  <span style="color:#75715e">//スロットル操作で失われた時間
</span><span style="color:#75715e"></span>unsigned <span style="color:#66d9ef">long</span> curr<span style="color:#f92672">;</span>           <span style="color:#75715e">/*現在時刻を取得*/</span>
unsigned <span style="color:#66d9ef">long</span> prev_ST <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>    <span style="color:#75715e">/*前時刻を保存*/</span>
unsigned <span style="color:#66d9ef">long</span> prev_TH <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>    <span style="color:#75715e">/*前時刻を保存*/</span>

<span style="color:#75715e">/*Bluetooth通信に必要*/</span>
BluetoothSerial ESP_BT<span style="color:#f92672">;</span>  <span style="color:#75715e">//ESP_BTという名前でオブジェクトを定義
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*割り込み関数onTimerで実行される内容*/</span>
<span style="color:#66d9ef">void</span> IRAM_ATTR <span style="color:#a6e22e">onTimer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  digitalWrite<span style="color:#f92672">(</span>LED_PIN<span style="color:#f92672">,</span> <span style="color:#f92672">!</span>digitalRead<span style="color:#f92672">(</span>LED_PIN<span style="color:#f92672">));</span>  <span style="color:#75715e">//前の出力と反転して点灯（チカチカする）
</span><span style="color:#75715e"></span>  t2 <span style="color:#f92672">=</span> millis<span style="color:#f92672">();</span>                                 <span style="color:#75715e">//割り込み時の時間を測定（100ms間隔）
</span><span style="color:#75715e"></span>  td <span style="color:#f92672">=</span> t2 <span style="color:#f92672">-</span> t1<span style="color:#f92672">;</span>                                  <span style="color:#75715e">//割り込み時の時間と命令取得時間の差を取る。この差が大きいとき、アプリは起動していない状態。
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#75715e">/*PWM制御でサーボモータの角度を制御する関数*/</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">change_ST_pos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> goal_pos<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">/*20000[μs]周期で幅CH1[μs]のパルス波生成*/</span>
  digitalWrite<span style="color:#f92672">(</span>SERVO_PWM_PIN<span style="color:#f92672">,</span> HIGH<span style="color:#f92672">);</span>  <span style="color:#75715e">//PWMピンの電圧を5[V]に
</span><span style="color:#75715e"></span>  delayMicroseconds<span style="color:#f92672">(</span>goal_pos<span style="color:#f92672">);</span>        <span style="color:#75715e">//パルス幅(goal_pos=900~2100[μs]：DB777WPの場合)
</span><span style="color:#75715e"></span>  digitalWrite<span style="color:#f92672">(</span>SERVO_PWM_PIN<span style="color:#f92672">,</span> LOW<span style="color:#f92672">);</span>   <span style="color:#75715e">//PWMピンの電圧を0[V]に
</span><span style="color:#75715e"></span>  delayMicroseconds<span style="color:#f92672">(</span>PWM_period<span style="color:#f92672">);</span>      <span style="color:#75715e">//制御周期（T=20000[μs]）
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#75715e">/*PWM制御でスロットルを制御する関数*/</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">change_TH_pos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> goal_pos<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">/*20000[μs]周期で幅CH1[μs]のパルス波生成*/</span>
  digitalWrite<span style="color:#f92672">(</span>ESC_PWM_PIN<span style="color:#f92672">,</span> HIGH<span style="color:#f92672">);</span>  <span style="color:#75715e">//PWMピンの電圧を5[V]に
</span><span style="color:#75715e"></span>  delayMicroseconds<span style="color:#f92672">(</span>goal_pos<span style="color:#f92672">);</span>      <span style="color:#75715e">//パルス幅(goal_pos=900~2100[μs]：DB777WPの場合)
</span><span style="color:#75715e"></span>  digitalWrite<span style="color:#f92672">(</span>ESC_PWM_PIN<span style="color:#f92672">,</span> LOW<span style="color:#f92672">);</span>   <span style="color:#75715e">//PWMピンの電圧を0[V]に
</span><span style="color:#75715e"></span>  delayMicroseconds<span style="color:#f92672">(</span>PWM_period<span style="color:#f92672">);</span>    <span style="color:#75715e">//制御周期（T=20000[μs]）
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#75715e">/*文字列を分割するための関数（分割数を戻り値とする）*/</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">split</span><span style="color:#f92672">(</span>String data<span style="color:#f92672">,</span> <span style="color:#66d9ef">char</span> delimiter<span style="color:#f92672">,</span> String <span style="color:#f92672">*</span>dst<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// data:分割したい文字列、delimiter:区切り文字、*dst:分割後の文字を入れる配列
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>                   <span style="color:#75715e">//分割後の文字をどこに入れるか決める
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> i<span style="color:#f92672">;</span>                           <span style="color:#75715e">//カウンタ変数
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> datalength <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span>  <span style="color:#75715e">//文字列の長さを取得
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> datalength<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">//文字列を1文字ずつスキャン
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> tmp <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>        <span style="color:#75715e">//tmp:文字を入れておく一時的な変数
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tmp <span style="color:#f92672">==</span> delimiter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      index<span style="color:#f92672">++;</span>  <span style="color:#75715e">//区切り文字があったら、配列の添え字を増やす
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      dst<span style="color:#f92672">[</span>index<span style="color:#f92672">]</span> <span style="color:#f92672">+=</span> tmp<span style="color:#f92672">;</span>  <span style="color:#75715e">//文字を1文字ずつ結合して、文字列を作成
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">/*出力ピン設定*/</span>
  pinMode<span style="color:#f92672">(</span>SERVO_PWM_PIN<span style="color:#f92672">,</span> OUTPUT<span style="color:#f92672">);</span>     <span style="color:#75715e">//サーボモータのピンへ、ArduinoからPWM出力するように設定
</span><span style="color:#75715e"></span>  pinMode<span style="color:#f92672">(</span>ESC_PWM_PIN<span style="color:#f92672">,</span> OUTPUT<span style="color:#f92672">);</span>       <span style="color:#75715e">//ESCのピンへ、ArduinoからPWM出力するように設定
</span><span style="color:#75715e"></span>  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">begin</span><span style="color:#f92672">(</span>115200<span style="color:#f92672">);</span>               <span style="color:#75715e">//シリアルモニタで確認用。伝送速度を115200[bps]に設定
</span><span style="color:#75715e"></span>  ESP_BT<span style="color:#f92672">.</span><span style="color:#a6e22e">begin</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ESP32_RC_Receiver&#34;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">//接続画面で表示される名前を設定 ★好きな名前にしてよい
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">/*割り込み処理（アプリ停止の検知に必要）の設定*/</span>
  pinMode<span style="color:#f92672">(</span>LED_PIN<span style="color:#f92672">,</span> OUTPUT<span style="color:#f92672">);</span>                     <span style="color:#75715e">//LEDの点灯ピンを出力用に設定
</span><span style="color:#75715e"></span>  timer <span style="color:#f92672">=</span> timerBegin<span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 80<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>              <span style="color:#75715e">//80クロック1カウント
</span><span style="color:#75715e"></span>  timerAttachInterrupt<span style="color:#f92672">(</span>timer<span style="color:#f92672">,</span> <span style="color:#f92672">&amp;</span>onTimer<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>  <span style="color:#75715e">//onTimerという名前の関数で割り込み
</span><span style="color:#75715e"></span>  timerAlarmWrite<span style="color:#f92672">(</span>timer<span style="color:#f92672">,</span> 1000000 <span style="color:#f92672">*</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">1</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>  <span style="color:#75715e">//80クロック×1000000カウント=1秒、1*0.1=100[ms]
</span><span style="color:#75715e"></span>  timerAlarmEnable<span style="color:#f92672">(</span>timer<span style="color:#f92672">);</span>                      <span style="color:#75715e">//タイマー有効化
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ESP_BT<span style="color:#f92672">.</span><span style="color:#a6e22e">available</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>               <span style="color:#75715e">//available()で受信した文字があるか確認。あればif文内の処理を実行。
</span><span style="color:#75715e"></span>    t1 <span style="color:#f92672">=</span> millis<span style="color:#f92672">();</span>                        <span style="color:#75715e">//データを取得した時間を記録
</span><span style="color:#75715e"></span>    input <span style="color:#f92672">=</span> ESP_BT<span style="color:#f92672">.</span><span style="color:#a6e22e">readStringUntil</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;;&#39;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">//文字をセミコロン(;)まで読んで、文字列として変数inputに保存。
</span><span style="color:#75715e"></span>    String cmds<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;\0&#34;</span> <span style="color:#f92672">};</span>            <span style="color:#75715e">//この配列に分割された信号を格納
</span><span style="color:#75715e"></span>
    split<span style="color:#f92672">(</span>input<span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">,</span> cmds<span style="color:#f92672">);</span>  <span style="color:#75715e">//文字列inputを分割＆cmdsに保存
</span><span style="color:#75715e"></span>
    CH1 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>cmds<span style="color:#f92672">[</span>0<span style="color:#f92672">]).</span><span style="color:#a6e22e">toInt</span><span style="color:#f92672">();</span>  <span style="color:#75715e">//CH1（ステア）の値
</span><span style="color:#75715e"></span>    CH2 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>cmds<span style="color:#f92672">[</span>1<span style="color:#f92672">]).</span><span style="color:#a6e22e">toInt</span><span style="color:#f92672">();</span>  <span style="color:#75715e">//CH2（スロットル）の値
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// /*受信したパルス幅の表示*/
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Serial.print(CH1);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Serial.print(&#39;,&#39;);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Serial.print(CH2);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Serial.print(&#39;\n&#39;);
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#75715e">/*Pボタンが押されたらラジコンの操作を有効する（安全のため）*/</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">==</span> 1 <span style="color:#f92672">&amp;&amp;</span> CH2 <span style="color:#f92672">==</span> 1500<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    flag <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">/*アプリ起動時（flag==0のとき）は操作を有効にする*/</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    change_ST_pos<span style="color:#f92672">(</span>CH1<span style="color:#f92672">);</span>  <span style="color:#75715e">//受信したパルス幅でサーボモータの角度を制御
</span><span style="color:#75715e"></span>    change_TH_pos<span style="color:#f92672">(</span>CH2<span style="color:#f92672">);</span>  <span style="color:#75715e">//受信したパルス幅でスロットルを制御
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#75715e">/*シリアルモニタで確認用（ラジコンの制御には無関係）*/</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Received signal=&#34;</span><span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>input<span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;t1=&#34;</span><span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>t1<span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;t2=&#34;</span><span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>t2<span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;t2-t1=&#34;</span><span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>td<span style="color:#f92672">);</span>
  Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">);</span>

  <span style="color:#75715e">/*アプリがバックグラウンドに入ったとき（もしくは閉じたとき）、車体を停止させる処理（安全のため）*/</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>td <span style="color:#f92672">&gt;</span> 150<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Transmitter is NOT active&#34;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">//NOT active：アプリはバックグラウンド状態（もしく閉じている）
</span><span style="color:#75715e"></span>    Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">);</span>
    change_TH_pos<span style="color:#f92672">(</span>neutral_pos<span style="color:#f92672">);</span>  <span style="color:#75715e">//中立(Neutral)
</span><span style="color:#75715e"></span>    input <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">;</span>
    digitalWrite<span style="color:#f92672">(</span>LED_PIN_ACTIVE<span style="color:#f92672">,</span> LOW<span style="color:#f92672">);</span>  <span style="color:#75715e">//アプリがバックグラウンドに入ったとき（もしくは閉じたとき）はLEDを消灯
</span><span style="color:#75715e"></span>    flag <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>                           <span style="color:#75715e">//アプリがバックグラウンド状態に入った（もしく閉じた）ときはflag=1に設定
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Transmitter is active&#34;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">//active：アプリの画面が開いている
</span><span style="color:#75715e"></span>    Serial<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">);</span>
    digitalWrite<span style="color:#f92672">(</span>LED_PIN_ACTIVE<span style="color:#f92672">,</span> HIGH<span style="color:#f92672">);</span>  <span style="color:#75715e">//アプリ起動時（画面を開いているとき）にはLEDを点灯
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span></code></pre></div>
<h1 id="4-実験動画">4. 実験動画</h1>
<p>　自作スマホアプリ上のスライダを動かすと、ステア（ハンドル）とスロットル（アクセル）が動きました！(/・ω・)/</p>
<p>　色々なラジコンカーを操作できて嬉しいです！
<br><br></p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/mukWWgoAdaI" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h1 id="5-サンプルファイル">5. サンプルファイル</h1>
<p>　作成したアプリのデータはこちらになります。改良して愛車に搭載するなど自由に楽しんでください！</p>
<p><strong>～ MIT App Inventorプロジェクトのファイル(.aia) ～</strong></p>
<ul>
<li><a href="Happy_RC_Driver_7a.aia">Happy_RC_Driver_7a.aia</a></li>
</ul>
<p><strong>～ ビルド済み Androidアプリのファイル(.apk) ～</strong></p>
<ul>
<li><a href="Happy_RC_Driver_7a.apk">Happy_RC_Driver_7a.apk</a></li>
</ul>
<h1 id="6-参考文献">6. 参考文献</h1>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>joho.info「【Arduino】文字列を区切り文字で分割(split関数)」、(<a href="https://algorithm.joho.info/arduino/string-split-delimiter/">https://algorithm.joho.info/arduino/string-split-delimiter/</a>)&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>KIO4.com「App inventor 2 en español」、(<a href="http://kio4.com/appinventor/294K_extension_crear_Deslizador.htm">http://kio4.com/appinventor/294K_extension_crear_Deslizador.htm</a>)&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>GitHub「SliderTools-AI2-Kodular-Extension」、(<a href="https://github.com/WatermelonOof/SliderTools-AI2-Kodular-Extension/">https://github.com/WatermelonOof/SliderTools-AI2-Kodular-Extension/</a>)&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>Coding Hats「How to use Switch component in MIT App Inventor」、(<a href="https://www.youtube.com/watch?v=bUoFdjTRsmI">https://www.youtube.com/watch?v=bUoFdjTRsmI</a>)&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


    </main><footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      TeX: { equationNumbers: {autoNumber: "AMS"} },
      tex2jax: {
        inlineMath: [['$','$']]
      }
    });
  </script>
  
  
  
  
  <div class="prev-next">
    <a
      class="active icon"
      href="/Happy_RC.github.io/2023/02/20/"
      aria-label="Previous Article"
      ><i class="bi bi-arrow-left-circle-fill"></i
    ></a>
    <a
      class="active icon"
      href="/Happy_RC.github.io/2023/03/28/"
      aria-label="Next Article"
      ><i class="bi bi-arrow-right-circle-fill"></i
    ></a>
  </div>
  </div>
  
  <div class="footer shadow round-corner">
    
    <div class="grid-container">
      <div class="footer-recent-posts">
        <h6>Recent Posts</h6>
        <ol>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/03/28/">Motoメモの保存先</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/03/16/">Bluetooth モジュールでRCサーボ・ESCを制御したい [第10回-スライダ操作式のラジコンアプリに]</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/02/20/">ラジコンカー用スピードメータ開発！</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2023/01/02/">スマホからサーボモータをPWM制御してみた!!</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2022/12/30/">自作アプリでBluetooth接続できない！[Runtime Error]</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2022/12/04/">ESP32でフォトリフレクタを使いたい！</a></li>
          
          <li><a href="https://tomokiikegami.github.io/Happy_RC.github.io/2022/11/06/">Bluetooth モジュールでRCサーボ・ESCを制御したい [第9回-外出先でもプログラムを編集したい]</a></li>
          
        </ol>
        <a href="/Happy_RC.github.io/archive">...ALL POSTS</a>
        <hr class="mobile white-hr" />
      </div>
      <div>
        <h6>Sections</h6>
<div class="section-container">
  
  
  <a class="section" href="https://tomokiikegami.github.io/Happy_RC.github.io/post/" aria-label="site sections"
    >Posts</a
  >
  
  
  
  
  
  
</div>

        









<h6>
  Tags
</h6>

<div class="taxa-container">
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/arduino/">Arduino</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E7%84%A1%E7%B7%9A%E9%80%9A%E4%BF%A1/">無線通信</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/mit-app-inventor/">MIT App Inventor</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%82%B5%E3%83%BC%E3%83%9C/">サーボ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E8%87%AA%E4%BD%9C%E3%82%A2%E3%83%97%E3%83%AA/">自作アプリ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/esc/">ESC</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/freecad/">FreeCAD</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/3d%E3%83%A2%E3%83%87%E3%83%AA%E3%83%B3%E3%82%B0/">3Dモデリング</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E6%A9%9F%E6%A2%B0%E8%A8%AD%E8%A8%88/">機械設計</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/3d%E3%83%97%E3%83%AA%E3%83%B3%E3%82%BF/">3Dプリンタ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%82%AE%E3%82%A2/">ギア</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/ultimaker-cura/">Ultimaker Cura</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%82%B9%E3%83%9E%E3%83%9B/">スマホ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/arduinodroid/">ArduinoDroid</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/html%E3%82%BF%E3%82%B0/">htmlタグ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/hugo/">hugo</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/libreoffice-draw/">LibreOffice Draw</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/word/">Word</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97/">バックアップ</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E3%83%9C%E3%83%87%E3%82%A3%E5%A1%97%E8%A3%85/">ボディ塗装</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E5%9B%B3%E3%81%AE%E4%BD%9C%E6%88%90/">図の作成</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E6%96%87%E5%AD%97%E8%A3%85%E9%A3%BE/">文字装飾</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/tags/%E8%A8%88%E6%B8%AC%E5%88%B6%E5%BE%A1/">計測制御</a>
  
</div>


<h6>
  Categories
</h6>

<div class="taxa-container">
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/categories/%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3/">ラジコン</a>
  
  
    <a class="taxa" href="https://tomokiikegami.github.io/Happy_RC.github.io/categories/%E5%82%99%E5%BF%98%E9%8C%B2/">備忘録</a>
  
</div>


        <hr class="mobile white-hr" />
      </div>
    </div>
    
    <div class="footer-info-text">
      <p>
        
        <span>2023</span>
        <span>Tomoki Ikegami.</span>
        <span>I hope to enjoy your RC Life.</span>
      </p>
      <p>
        <a href="https://github.com/urjaacharya/redgood">redgood</a>
        by
        <a
          href="https://www.urjaacharya.com/"
          aria-label="link to urja acharya site"
        >urja acharya</a>
      </p>
    </div>
    <div style="text-align: right; margin-bottom: 0.25em; font-size: 1.2em">
      <a class="primary-icon to-top" href="#" aria-label="navigate to top">
        <i class="bi bi-arrow-up-circle-fill"></i>
      </a>
    </div>
  </div>
</footer>
</body>
</html>
